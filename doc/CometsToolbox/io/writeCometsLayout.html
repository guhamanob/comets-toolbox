<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of writeCometsLayout</title>
  <meta name="keywords" content="writeCometsLayout">
  <meta name="description" content="WRITECOMETSLAYOUT Create a layout file along with the corresponding model">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- # CometsToolbox --><!-- menu.html io -->
<h1>writeCometsLayout
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>WRITECOMETSLAYOUT Create a layout file along with the corresponding model</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function writeCometsLayout( input, filedir, filename, includeParams, writeModels) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment">WRITECOMETSLAYOUT Create a layout file along with the corresponding model
files</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../CometsToolbox/external/m2html/@template/char.html" class="code" title="function s = char(tpl)">char</a>	TEMPLATE Convert a template object in a one line description string</li><li><a href="writeCometsModel.html" class="code" title="function f = writeCometsModel( input, filename, cometsParams)">writeCometsModel</a>	WRITECOMETSMODEL create a Comets input file for the given model</li><li><a href="../../CometsToolbox/util/getModelName.html" class="code" title="function res = getModelName( model )">getModelName</a>	GETMODELNAME Parse the given COBRA model to return a name to be used in</li><li><a href="../../CometsToolbox/util/stridx.html" class="code" title="function [idx] = stridx(query, list, allowSubstr)">stridx</a>	STRIDX(str, {str}, [true]) Get the indexes of the query string in the given cell array.</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../CometsToolbox/core/run/createCometsFiles.html" class="code" title="function [ output_args ] = createCometsFiles(layout, directory, layoutFileName, separateParamsFiles)">createCometsFiles</a>	CREATECOMETSFILES(layout, [directory], [layoutFileName], [separateParamsFiles])</li><li><a href="../../CometsToolbox/sample/old/demo62.html" class="code" title="">demo62</a>	Import from SBML</li><li><a href="../../CometsToolbox/test/testSetInitialPop.html" class="code" title="">testSetInitialPop</a>	TESTSETINITIALPOP Confirm that the setInitialPop function works as</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function mname = getModelFileName(model)</a></li><li><a href="#_sub2" class="code">function mname = getModelFilePath(model)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function writeCometsLayout( input, filedir, filename, includeParams, writeModels)</a>
0002 <span class="comment">%WRITECOMETSLAYOUT Create a layout file along with the corresponding model</span>
0003 <span class="comment">%files</span>
0004 <span class="keyword">if</span> nargin == 2
0005     filename = <span class="string">'layout.txt'</span>;
0006     <span class="comment">%filedir = 'layout';</span>
0007 <span class="keyword">end</span>
0008 
0009 <span class="keyword">if</span> nargin &lt; 4
0010     includeParams = true; <span class="comment">%should the params block be printed within this file?</span>
0011 <span class="keyword">end</span>
0012 <span class="keyword">if</span> nargin &lt; 5
0013     writeModels = true;
0014 <span class="keyword">end</span>
0015 
0016 <span class="keyword">if</span> isa(input,<span class="string">'string'</span>)
0017     strct=load(input);
0018     layout=strct.(<a href="../../CometsToolbox/external/m2html/@template/char.html" class="code" title="function s = char(tpl)">char</a>(fieldnames(strct)));
0019 <span class="keyword">else</span>
0020     <span class="keyword">if</span> isa(input,<span class="string">'CometsLayout'</span>)
0021         layout=input;
0022     <span class="keyword">else</span>
0023         error([<span class="string">'Invalid argument in writeCometslayout('</span> class(input)<span class="keyword">...</span>
0024             <span class="string">', '</span> class(filename) <span class="string">'): The first argument should '</span><span class="keyword">...</span>
0025             <span class="string">'be a well-structured COMETS layout or the path of a '</span><span class="keyword">...</span>
0026             <span class="string">'.mat file containing one.'</span>]);
0027     <span class="keyword">end</span>
0028 <span class="keyword">end</span>
0029 
0030 <span class="comment">% %deprecated- CometsLayout is now a class in order to enforce this %assert</span>
0031 <span class="comment">% that the input is a well-structured COMETS layout %check for these fields</span>
0032 <span class="comment">% for cf=['models' 'xdim' 'ydim' 'mets' 'media_amt' 'params'</span>
0033 <span class="comment">% 'diffusion_const' 'media_refresh']</span>
0034 <span class="comment">%     if ~isfield(layout,cf)</span>
0035 <span class="comment">%         error(['Invalid argument in writeCometsLayout(' class(input)...</span>
0036 <span class="comment">%             ', ' class(filename) '): The input layout requires the '...</span>
0037 <span class="comment">%             'following fields: [models xdim ydim mets media_amt params</span>
0038 <span class="comment">%             diffusion_const media_refresh]. Identified fields are '</span>
0039 <span class="comment">%             (char(fieldnames(model)))]);</span>
0040 <span class="comment">%     end</span>
0041 <span class="comment">% end</span>
0042 
0043 <span class="comment">%enforce that layout.models and layout.mets are cell arrays, not single</span>
0044 <span class="comment">%objects in order to simplify parsing downstream</span>
0045 <span class="keyword">if</span> isstruct(layout.models)
0046     layout.models = {layout.models};
0047 <span class="keyword">end</span>
0048 <span class="keyword">if</span> ischar(layout.mets)
0049     layout.mets = {layout.mets};
0050 <span class="keyword">end</span>
0051 <span class="keyword">if</span> ~iscell(layout.models)
0052     error([<span class="string">'Error in layout format: models should be of type cell array'</span><span class="keyword">...</span>
0053         <span class="string">'or be a single COBRA model struct.'</span>]);
0054 <span class="keyword">end</span>
0055 <span class="keyword">if</span> ~iscell(layout.mets)
0056     error([<span class="string">'Error in layout format: mets should be of type cell array'</span><span class="keyword">...</span>
0057         <span class="string">'or char.'</span>]);
0058 <span class="keyword">end</span>
0059 
0060 <span class="comment">%sort the metabolites in the layout alphabetically. Some sections of the</span>
0061 <span class="comment">%layout file may refer to media by their position in the sorted list, not</span>
0062 <span class="comment">%their position in the world_media section</span>
0063 layout = sortMetabolites(layout);
0064 
0065 
0066 filename = fullfile(filedir,filename);
0067 fileID=fopen(filename,<span class="string">'w'</span>);
0068 
0069 <span class="comment">% Parameters</span>
0070 <span class="comment">%</span>
0071 <span class="comment">% This block contains parameters initially loaded with the file. A list of</span>
0072 <span class="comment">% these with their accepted values is here. Here’s the structure of the</span>
0073 <span class="comment">% block:</span>
0074 <span class="comment">%</span>
0075 <span class="comment">% parameters</span>
0076 <span class="comment">%   param_1 = value_1</span>
0077 <span class="comment">%   param_2 = value_2</span>
0078 <span class="comment">%   . . .</span>
0079 <span class="comment">%   param_N = value_N</span>
0080 <span class="comment">% //</span>
0081 <span class="comment">%</span>
0082 <span class="comment">% This block is included at the top of the file for now because</span>
0083 <span class="comment">% flowDiffRate and growthDiffRate will only be applied if parameters are</span>
0084 <span class="comment">% loaded before model files.</span>
0085 <span class="keyword">if</span> includeParams
0086     fprintf(fileID,<span class="string">'\tparameters\n'</span>);
0087     
0088     pfields = fieldnames(layout.params);
0089     dontPrint = {<span class="string">'defaultReactionLower'</span>,<span class="string">'defaultReactionUpper'</span>,<span class="string">'defaultDiffConst'</span>,<span class="string">'objectiveStyle'</span>};
0090     logicalFields = {<span class="string">'writeBiomassLog'</span>,<span class="string">'writeFluxLog'</span>,<span class="string">'writeMediaLog'</span>,<span class="string">'writeTotalBiomassLog'</span>,<span class="keyword">...</span>
0091         <span class="string">'useLogNameTimeStamp'</span>,<span class="string">'showCycleTime'</span>,<span class="string">'showCycleCount'</span>,<span class="string">'saveslideshow'</span>,<span class="keyword">...</span>
0092         <span class="string">'slideshowColorRelative'</span>,<span class="string">'simulateActivation'</span>,<span class="string">'randomOrder'</span>,<span class="string">'pauseOnStep'</span>,<span class="string">'allowCellOverlap'</span>,<span class="keyword">...</span>
0093         <span class="string">'toroidalWorld'</span>,<span class="string">'colorRelative'</span>,<span class="string">'slideshowColorRelative'</span>};
0094     <span class="keyword">for</span> i = 1:length(pfields)
0095         p = pfields{i};
0096         <span class="keyword">if</span> ~ismember(p,dontPrint)
0097             c = <a href="../../CometsToolbox/external/m2html/@template/char.html" class="code" title="function s = char(tpl)">char</a>(p);
0098             val = getfield(layout.params,c);
0099             <span class="keyword">if</span> islogical(val) | ismember(c,logicalFields)
0100                 <span class="keyword">if</span> val
0101                     val = <span class="string">'true'</span>;
0102                 <span class="keyword">else</span>
0103                     val = <span class="string">'false'</span>;
0104                 <span class="keyword">end</span>
0105             <span class="keyword">end</span>
0106             <span class="comment">%     if ~ischar(val)</span>
0107             <span class="comment">%         val = char(val);</span>
0108             <span class="comment">%     end</span>
0109             fprintf(fileID,<span class="string">'\t%s = %s\n'</span>,<a href="../../CometsToolbox/external/m2html/@template/char.html" class="code" title="function s = char(tpl)">char</a>(p),num2str(val));
0110         <span class="keyword">end</span>
0111     <span class="keyword">end</span>
0112     fprintf(fileID,<span class="string">'//\n'</span>);
0113 <span class="keyword">end</span>
0114 
0115 
0116 <span class="comment">% The data blocks in this file are mostly nested within each other. The</span>
0117 <span class="comment">% model file block encapsulates the model world and initial population</span>
0118 <span class="comment">% blocks. The rest of the blocks are listed in the model world block.</span>
0119 
0120 
0121 <span class="comment">% 1. Model Names This is a single line block, NOT followed by // on a line</span>
0122 <span class="comment">% below, but at the end of the file. This must be the first line of the</span>
0123 <span class="comment">% layout file. It is followed by the name of at least one FBA model file.</span>
0124 <span class="comment">%</span>
0125 <span class="comment">% model_file model_file_name1 model_file_name2 ... model_file_name_N 2.</span>
0126 fprintf(fileID,<span class="string">'model_file'</span>);
0127 <span class="keyword">for</span> i = 1:length(layout.models)
0128     m = layout.models{i};
0129     fprintf(fileID,<span class="string">' %s'</span>,<a href="#_sub1" class="code" title="subfunction mname = getModelFileName(model)">getModelFileName</a>(m));
0130 <span class="keyword">end</span>
0131 fprintf(fileID,<span class="string">'\n'</span>);
0132 
0133 <span class="comment">% Model World</span>
0134 <span class="comment">%</span>
0135 <span class="comment">% This is a single line block, NOT followed by // on a line below, but</span>
0136 <span class="comment">% after several internal data blocks. This must be the first block inside</span>
0137 <span class="comment">% the model names block. It simply opens up the data block containing the</span>
0138 <span class="comment">% world information. Optionally, it can be followed by the name of a file</span>
0139 <span class="comment">% containing global media information (note that this is deprecated! Global</span>
0140 <span class="comment">% media information should be included in the layout file under the world</span>
0141 <span class="comment">% media block).</span>
0142 fprintf(fileID,<span class="string">'\tmodel_world\n'</span>);
0143 
0144 <span class="comment">% 2a. Grid Size</span>
0145 <span class="comment">%</span>
0146 <span class="comment">% This is required to be the first block under the model world line. It</span>
0147 <span class="comment">% doesn’t have a closing //, and only describes the width and height of the</span>
0148 <span class="comment">% simulation grid.</span>
0149 <span class="comment">%</span>
0150 <span class="comment">% grid_size  width  height</span>
0151 fprintf(fileID,<span class="string">'\t\tgrid_size %d %d\n'</span>,layout.xdim, layout.ydim);
0152 
0153 <span class="comment">% 2b. World Media</span>
0154 <span class="comment">%</span>
0155 <span class="comment">% The world media block contains global information of the quantity of all</span>
0156 <span class="comment">% extracellular metabolites in the simulation. Each row in the block has</span>
0157 <span class="comment">% two elements – the name of an extracellular metabolite (must be exactly</span>
0158 <span class="comment">% as found in the model file) followed by the quantity of that metabolite</span>
0159 <span class="comment">% initialized in every block in the simulation.</span>
0160 <span class="comment">%</span>
0161 <span class="comment">% This block must come before the media refresh, static media, and</span>
0162 <span class="comment">% diffusion constants blocks.</span>
0163 <span class="comment">%</span>
0164 <span class="comment">% world_media</span>
0165 <span class="comment">%   metab_1  quantity_1 metab_2  quantity_2 metab_3  quantity_3 . . .</span>
0166 <span class="comment">%   metab_N  quantity_N</span>
0167 <span class="comment">% //</span>
0168 fprintf(fileID,<span class="string">'\t\tworld_media\n'</span>);
0169 <span class="keyword">for</span> i = 1:length(layout.mets)
0170     m = layout.mets{i};
0171     idx = layout.metIdx(m);
0172     m = strrep(m,<span class="string">' '</span>,<span class="string">'_'</span>);
0173     fprintf(fileID,<span class="string">'\t\t%s %g\n'</span>,<a href="../../CometsToolbox/external/m2html/@template/char.html" class="code" title="function s = char(tpl)">char</a>(m),layout.media_amt(idx));
0174 <span class="keyword">end</span>
0175 fprintf(fileID,<span class="string">'\t//\n'</span>);
0176 <span class="comment">% 2c. Diffusion Constants</span>
0177 <span class="comment">%</span>
0178 <span class="comment">% The diffusion constants block contains diffusion constant information for</span>
0179 <span class="comment">% the extracellular metabolites in the simulation. The block begins with a</span>
0180 <span class="comment">% global default value on the same line as the opening tag. Each row in the</span>
0181 <span class="comment">% block, then, has two elements – the index of the metabolite in question,</span>
0182 <span class="comment">% in the same order as in the world_media block above (starting from 0);</span>
0183 <span class="comment">% and a value for the diffusion constant if it differs from the default.</span>
0184 <span class="comment">%</span>
0185 <span class="comment">% diffusion_constants    default_value</span>
0186 <span class="comment">%   index_1  diff_const_1 index_2  diff_const_2 index_3  diff_const_3 . . .</span>
0187 ddiff = layout.params.defaultDiffConst;
0188 fprintf(fileID,<span class="string">'\tdiffusion_constants %d\n'</span>,ddiff);
0189 <span class="keyword">if</span> any(layout.diffusion_constants(:,1))
0190     <span class="keyword">for</span> i = 1:length(layout.mets)
0191         m = layout.mets{i};
0192         idx = layout.metIdx(m);
0193         <span class="keyword">if</span> idx &amp;&amp; layout.diffusion_constants(idx,1) <span class="comment">%if the diffusion constant is set</span>
0194             dc = layout.diffusion_constants(idx,2);
0195             <span class="keyword">if</span> dc ~= ddiff <span class="comment">%and the diffusion constant is not equal to the default</span>
0196                 fprintf(fileID,<span class="string">'\t\t%d %g\n'</span>,idx-1,dc);
0197             <span class="keyword">end</span>
0198         <span class="keyword">end</span>
0199     <span class="keyword">end</span>
0200 <span class="keyword">end</span>
0201 fprintf(fileID,<span class="string">'\t//\n'</span>);
0202 
0203 <span class="comment">% // Media</span>
0204 <span class="comment">% TODO: This section should handle specification of media on a cell-by-cell</span>
0205 <span class="comment">% basis.</span>
0206 fprintf(fileID,<span class="string">'\tmedia\n'</span>);
0207 
0208 ms = size(layout.initial_media);
0209 <span class="comment">%s = [# metabolites in media, x, y]</span>
0210 
0211 <span class="keyword">if</span> length(ms) &lt; 3 <span class="comment">%don't break the loop if static_media is empty or 1x1</span>
0212     ms(3) = 1;
0213 <span class="keyword">end</span>
0214 
0215 <span class="keyword">for</span> x = 1:ms(2) <span class="comment">%for each x coordinate</span>
0216     <span class="keyword">for</span> y = 1:ms(3) <span class="comment">%and each y coordinate</span>
0217         v = layout.initial_media(:,x,y,1);<span class="comment">%is it set?</span>
0218         <span class="keyword">if</span> length(v) &lt; length(layout.mets)<span class="comment">%must include a value for all media</span>
0219             v(length(layout.mets)) = 0;
0220         <span class="keyword">end</span>
0221         <span class="keyword">if</span> any(v)
0222             fprintf(fileID,<span class="string">'\t\t%d %d'</span>,x-1,y-1);
0223             <span class="keyword">for</span> j = 1:length(v)
0224                 <span class="keyword">if</span> v(j) <span class="comment">%this medium is set</span>
0225                     fprintf(fileID,<span class="string">' %d'</span>, layout.initial_media(j,x,y,2));
0226                 <span class="keyword">else</span> <span class="comment">%use the global value</span>
0227                     fprintf(fileID,<span class="string">' %d'</span>, layout.media_amt(j));
0228                 <span class="keyword">end</span>
0229             <span class="keyword">end</span>
0230             fprintf(fileID,<span class="string">'\n'</span>);
0231         <span class="keyword">end</span>
0232     <span class="keyword">end</span>
0233 <span class="keyword">end</span>
0234 fprintf(fileID,<span class="string">'\t//\n'</span>);
0235 
0236 <span class="comment">% // 2d. Media Refresh</span>
0237 <span class="comment">%</span>
0238 <span class="comment">% This block describes how much each medium component should be refreshed</span>
0239 <span class="comment">% on each simulation cycle in any given grid space. The opening line</span>
0240 <span class="comment">% contains global refresh values for each medium component, in the same</span>
0241 <span class="comment">% order as presented in the world media block.</span>
0242 <span class="comment">%</span>
0243 <span class="comment">% Each proceeding row contains the amount of media to refresh for each grid</span>
0244 <span class="comment">% space where there is a nonzero refresh value. That is, the only rows that</span>
0245 <span class="comment">% should be present in this block should contain some amount of medium to</span>
0246 <span class="comment">% be refreshed.</span>
0247 <span class="comment">%</span>
0248 <span class="comment">% media_refresh  global_amt_1  global_amt_2  ...  global_amt_N</span>
0249 <span class="comment">%   row_1  col_1  amt_1  amt_2  amt_3  ...  amt_N row_2  col_2  amt_1 amt_2</span>
0250 <span class="comment">%   amt_3  ...  amt_N row_3  col_3  amt_1  amt_2  amt_3  ...  amt_N . . .</span>
0251 <span class="comment">%   row_M  col_M  amt_1  amt_2  amt_3  ...  amt_N</span>
0252 fprintf(fileID,<span class="string">'\tmedia_refresh'</span>);
0253 fprintf(fileID,<span class="string">' %d'</span>,layout.global_media_refresh);
0254 fprintf(fileID,<span class="string">'\n'</span>);
0255 
0256 [mdim,xdim,ydim] = size(layout.media_refresh);
0257 <span class="keyword">for</span> x = 1:xdim
0258     <span class="keyword">for</span> y = 1:ydim
0259         row = layout.media_refresh(1:mdim,x,y);
0260         <span class="keyword">if</span> any(row)
0261             <span class="comment">%fprintf(fileID,'\t\t%d %d %g\n',x-1,y-1,row);</span>
0262             fprintf(fileID,<span class="string">'\t\t%d %d '</span>,x-1,y-1);
0263             <span class="keyword">for</span> i = 1:length(row)
0264                 fprintf(fileID,<span class="string">'%d '</span>,row(i));
0265             <span class="keyword">end</span>
0266             fprintf(fileID,<span class="string">'\n'</span>);
0267         <span class="keyword">end</span>
0268     <span class="keyword">end</span>
0269 <span class="keyword">end</span>
0270 fprintf(fileID,<span class="string">'\t//\n'</span>);
0271 
0272 <span class="comment">% // 2e. Static Media</span>
0273 <span class="comment">%</span>
0274 <span class="comment">% Like the media refresh block, this describes how the media in each space</span>
0275 <span class="comment">% in the grid should be altered during the simulation. However, this block</span>
0276 <span class="comment">% describes which media components should remain at a static value. That</span>
0277 <span class="comment">% is, those media whose quantities should not change due to the effects of</span>
0278 <span class="comment">% the simulation. This might represent a constant sink or source of a</span>
0279 <span class="comment">% number of metabolites.</span>
0280 <span class="comment">%</span>
0281 <span class="comment">% This block contains pairs of data elements. Each pair starts with a</span>
0282 <span class="comment">% binary (0 or 1) element, denoting whether or not to use that pair as a</span>
0283 <span class="comment">% static element, and a quantity to keep that element static at. This lets</span>
0284 <span class="comment">% one build a static media set where only a few medium elements are</span>
0285 <span class="comment">% maintained as static, while keeping the file structure similar to the</span>
0286 <span class="comment">% media refresh block above.</span>
0287 <span class="comment">%</span>
0288 <span class="comment">% For example:</span>
0289 <span class="comment">%</span>
0290 <span class="comment">% static_media  0  0  1  0  1  2  0  0 // Breaks into 4 pairs [0 0], [1 0],</span>
0291 <span class="comment">% [1 2], [0 0]. Only components 2 and 3 have a 1 as their first element, so</span>
0292 <span class="comment">% those medium components are kept static. Component 2 remains at 0, while</span>
0293 <span class="comment">% component 3 stays at 2. Note that in this example, there are no</span>
0294 <span class="comment">% exceptions, so this applies throughout the simulation. In general, it is</span>
0295 <span class="comment">% done like this:</span>
0296 <span class="comment">%</span>
0297 <span class="comment">% static_media  use_1  amt_1  use_2  amt_2  use_3  amt_3  ...  use_N  amt_N</span>
0298 <span class="comment">%   row_1  col_1  use_1  amt_1  use_2  amt_2  ...  use_N  amt_N row_2 col_2</span>
0299 <span class="comment">%   use_1  amt_1  use_2  amt_2  ...  use_N  amt_N row_3  col_3 use_1  amt_1</span>
0300 <span class="comment">%   use_2  amt_2  ...  use_N  amt_N . . . row_M  col_M  use_1 amt_1  use_2</span>
0301 <span class="comment">%   amt_2  ...  use_N  amt_N</span>
0302 fprintf(fileID,<span class="string">'\tstatic_media'</span>);
0303 gs = size(layout.global_static_media);
0304 <span class="keyword">for</span> row = 1:gs(1)
0305     fprintf(fileID,<span class="string">' %g'</span>,layout.global_static_media(row,:));
0306 <span class="keyword">end</span>
0307 fprintf(fileID,<span class="string">'\n'</span>);
0308 
0309 s = size(layout.static_media);
0310 
0311 <span class="keyword">if</span> length(s) &lt; 3 <span class="comment">%don't break the loop if static_media is empty or 1x1</span>
0312     s(3) = 1;
0313 <span class="keyword">end</span>
0314 
0315 <span class="keyword">if</span> any(layout.static_media(:,:,:,1))
0316     <span class="keyword">for</span> x = 1:s(2)
0317         <span class="keyword">for</span> y = 1:s(3)
0318             b = layout.static_media(:,x,y,1);<span class="comment">%is this medium static?</span>
0319             v = layout.static_media(:,x,y,2);<span class="comment">%values</span>
0320             i = find(b); <span class="comment">%indexes</span>
0321             <span class="keyword">if</span> any(i)
0322                 <span class="comment">%            b = zeros(1,gs(1));</span>
0323                 <span class="comment">%            b(i) = 1; %is this medium static?</span>
0324                 sm = [b';v'];
0325                 row = sm(1:(2*gs(1)));<span class="comment">%pairs of logical/value for each media</span>
0326                 fprintf(fileID,<span class="string">'\t\t%d %d'</span>,x-1,y-1);
0327                 <span class="keyword">for</span> j = 1:length(row)
0328                     fprintf(fileID,<span class="string">' %d'</span>,row(j));
0329                 <span class="keyword">end</span>
0330                 fprintf(fileID,<span class="string">'\n'</span>);
0331             <span class="keyword">end</span>
0332         <span class="keyword">end</span>
0333     <span class="keyword">end</span>
0334 <span class="keyword">end</span>
0335 fprintf(fileID,<span class="string">'\t//\n'</span>);
0336 
0337 <span class="comment">% // 2f. Barrier Coordinates</span>
0338 <span class="comment">%</span>
0339 <span class="comment">% Simple enough, this block describes those grid coordinates that contain</span>
0340 <span class="comment">% barriers (i.e., no media, biomass, or diffusion can occur here).</span>
0341 <span class="comment">%</span>
0342 <span class="comment">% barrier</span>
0343 <span class="comment">%   row_1  col_1 row_2  col_2 row_3  col_3 . . . row_N  col_N</span>
0344 fprintf(fileID,<span class="string">'\tbarrier\n'</span>);
0345 s = size(layout.barrier);
0346 <span class="keyword">for</span> x = 1:s(1)
0347     <span class="keyword">for</span> y = 1:s(2)
0348         <span class="keyword">if</span> layout.barrier(x,y)
0349             fprintf(fileID,<span class="string">'\t\t%d %d\n'</span>,x-1,y-1);
0350         <span class="keyword">end</span>
0351     <span class="keyword">end</span>
0352 <span class="keyword">end</span>
0353 
0354 fprintf(fileID,<span class="string">'\t//\n//\n'</span>);
0355 <span class="comment">% // 3. Initial Biomass Population</span>
0356 <span class="comment">%</span>
0357 <span class="comment">% This final block describes the initial biomass population in the layout,</span>
0358 <span class="comment">% and has many options.</span>
0359 <span class="comment">%</span>
0360 <span class="comment">% In the default biomass layout style, there is just initial_pop left alone</span>
0361 <span class="comment">% as the header, followed by one row for each grid space containing</span>
0362 <span class="comment">% biomass. There must be one quantity for each metabolic model in the</span>
0363 <span class="comment">% system.</span>
0364 <span class="comment">%</span>
0365 <span class="comment">% initial_pop</span>
0366 <span class="comment">%   row_1  col_1  biomass_1  biomass_2  ...  biomass_N row_2  col_2</span>
0367 <span class="comment">%   biomass_1  biomass_2  ...  biomass_N row_3  col_3  biomass_1  biomass_2</span>
0368 <span class="comment">%   ...  biomass_N . . . row_M  col_M  biomass_1  biomass_2  ...  biomass_N</span>
0369 <span class="comment">% // The next set of options modify the initial_pop line itself, and</span>
0370 <span class="comment">% contain no rows in the block, though the // on the line below must be</span>
0371 <span class="comment">% present.</span>
0372 <span class="comment">% NOTE: all coordinates here are 0-indexed!</span>
0373 <span class="comment">%</span>
0374 <span class="comment">% initial_pop  random  N1  biomass_1  N2  biomass_2 ... // This will</span>
0375 <span class="comment">% randomly assign Ni spaces to have biomass_i amount of biomass from model</span>
0376 <span class="comment">% i. If biomass from different species is allowed to overlap, then that is</span>
0377 <span class="comment">% allowed to happen in this case, but if different species is not allowed</span>
0378 <span class="comment">% to overlap, then that rule is upheld.</span>
0379 <span class="comment">%</span>
0380 <span class="comment">% initial_pop  random_rect  X  Y  W  H  N1  biomass_1  N2  biomass_2 ... //</span>
0381 <span class="comment">% As above, but the randomly assigned biomass spots are confined to a</span>
0382 <span class="comment">% rectangle with its upper-left corner at grid space (X,Y), with W grid</span>
0383 <span class="comment">% spaces wide, and H spaces tall.</span>
0384 <span class="comment">%</span>
0385 <span class="comment">% initial_pop  filled  biomass_1  biomass_2 ... // This will completely</span>
0386 <span class="comment">% fill the grid with the given amount of biomass from each species.</span>
0387 <span class="comment">%</span>
0388 <span class="comment">% initial_pop  filled_rect  X  Y  W  H  biomass_1  biomass_2 ... // This</span>
0389 <span class="comment">% will completely fill the rectangle (see above) with biomass from each</span>
0390 <span class="comment">% species.</span>
0391 <span class="comment">%</span>
0392 <span class="comment">% initial_pop  square  N1  biomass_1  N2  biomass_2 ... // This will fill</span>
0393 <span class="comment">% squares with radius Ni at the center of the grid with biomass_i from</span>
0394 <span class="comment">% species i.</span>
0395 <span class="keyword">if</span> sum(sum(any(layout.initial_pop))) &gt; 0 <span class="comment">%some initial pop is set</span>
0396     fprintf(fileID,<span class="string">'initial_pop\n'</span>);
0397     s = size(layout.initial_pop);
0398     <span class="keyword">if</span> length(s) &lt; 3 <span class="comment">%don't break the loop if initial_pop is empty or 1x1</span>
0399         s(3) = 1;
0400     <span class="keyword">end</span>
0401     <span class="keyword">for</span> x = 1:s(2)
0402         <span class="keyword">for</span> y = 1:s(3)
0403             v = layout.initial_pop(:,x,y);
0404             <span class="keyword">if</span> any(v)
0405                 <span class="comment">%x y pop1 pop2 pop3...</span>
0406                 fprintf(fileID,[<span class="string">'\t%d %d'</span> sprintf(<span class="string">' %d'</span>,v) <span class="string">'\n'</span>],x-1,y-1);
0407             <span class="keyword">end</span>
0408         <span class="keyword">end</span>
0409     <span class="keyword">end</span>
0410     fprintf(fileID,<span class="string">'//\n'</span>);
0411 <span class="keyword">else</span> <span class="comment">%no initial pop is set</span>
0412     fprintf(fileID,<span class="string">'initial_pop filled'</span>);
0413     <span class="keyword">for</span> i=1:length(layout.models)
0414         fprintf(fileID,<span class="string">' 1E-7'</span>);
0415     <span class="keyword">end</span>
0416     fprintf(fileID,<span class="string">'\n'</span>);
0417     fprintf(fileID,<span class="string">'//\n'</span>);
0418 <span class="keyword">end</span>
0419 
0420 <span class="comment">%if external reactions are set, print the relevent block</span>
0421 <span class="keyword">if</span> ~isempty(layout.external_rxn_mets)
0422     fprintf(fileID,<span class="string">'reactions\n'</span>);
0423     fprintf(fileID,<span class="string">'\treactants\n'</span>);
0424     mets = layout.external_rxn_mets;
0425     rxns = layout.external_rxns;
0426     metdims = size(mets);
0427     nrows = metdims(1);
0428     reactionnames = rxns.name;
0429     <span class="keyword">for</span> i = 1:nrows
0430         row = mets(i,:);
0431         <span class="keyword">if</span> row.stoich &lt; 0 <span class="comment">%only write reactants here</span>
0432             metidx = <a href="../../CometsToolbox/util/stridx.html" class="code" title="function [idx] = stridx(query, list, allowSubstr)">stridx</a>(row.met{1},layout.mets,false);
0433             rxnidx = <a href="../../CometsToolbox/util/stridx.html" class="code" title="function [idx] = stridx(query, list, allowSubstr)">stridx</a>(row.rxn{1},reactionnames,false);
0434             rxnrow = rxns(rxnidx,:);
0435             <span class="keyword">if</span> isempty(rxnrow.enzyme{1}) <span class="comment">%no enzyme</span>
0436                 sto = -row.stoich;
0437                 k = rxnrow.k;
0438                 fprintf(fileID,<span class="string">'\t\t%d %d %d %d\n'</span>, rxnidx, metidx, sto, k);
0439             <span class="keyword">else</span> <span class="comment">%enzyme catalyzed</span>
0440                 km = rxnrow.km;
0441                 fprintf(fileID,<span class="string">'\t\t%d %d %d\n'</span>, rxnidx, metidx, km);
0442             <span class="keyword">end</span>
0443         <span class="keyword">end</span>
0444     <span class="keyword">end</span>
0445     fprintf(fileID,<span class="string">'\tenzymes\n'</span>);
0446     rxndims = size(rxns);
0447     nrows = rxndims(1);
0448     <span class="keyword">for</span> i = 1:nrows
0449         row = rxns(i,:);
0450         <span class="keyword">if</span> ~isempty(row.enzyme{1})
0451             enzidx = <a href="../../CometsToolbox/util/stridx.html" class="code" title="function [idx] = stridx(query, list, allowSubstr)">stridx</a>(row.enzyme{1},layout.mets,false);
0452             fprintf(fileID,<span class="string">'\t\t%d %d %d\n'</span>, i, enzidx, row.k);
0453         <span class="keyword">end</span>
0454     <span class="keyword">end</span>
0455     fprintf(fileID,<span class="string">'\tproducts\n'</span>);
0456     nrows = metdims(1);
0457     <span class="keyword">for</span> i = 1:nrows
0458         row = mets(i,:);
0459         rxnidx = <a href="../../CometsToolbox/util/stridx.html" class="code" title="function [idx] = stridx(query, list, allowSubstr)">stridx</a>(row.rxn{1},reactionnames,false);
0460         <span class="keyword">if</span> row.stoich &gt; 0
0461             metidx = <a href="../../CometsToolbox/util/stridx.html" class="code" title="function [idx] = stridx(query, list, allowSubstr)">stridx</a>(row.met{1},layout.mets,false);
0462             sto = row.stoich;
0463             fprintf(fileID,<span class="string">'\t\t%d %d %d\n'</span>, rxnidx, metidx, sto);
0464         <span class="keyword">end</span>
0465     <span class="keyword">end</span>
0466     fprintf(fileID,<span class="string">'//\n'</span>);
0467 <span class="keyword">end</span>
0468 
0469 fclose(fileID);
0470 
0471 <span class="comment">%write the model files</span>
0472 <span class="keyword">if</span> writeModels
0473     <span class="keyword">for</span> i = 1:length(layout.models)
0474         m = layout.models{i};
0475         <a href="writeCometsModel.html" class="code" title="function f = writeCometsModel( input, filename, cometsParams)">writeCometsModel</a>(m,<a href="#_sub2" class="code" title="subfunction mname = getModelFilePath(model)">getModelFilePath</a>(m),layout.params);
0476     <span class="keyword">end</span>
0477 <span class="keyword">end</span>
0478 
0479     <a name="_sub1" href="#_subfunctions" class="code">function mname = getModelFileName(model)</a>
0480         name = <a href="../../CometsToolbox/util/getModelName.html" class="code" title="function res = getModelName( model )">getModelName</a>(model);
0481         mname = [name <span class="string">'.txt'</span>]; <span class="comment">%relative path; file goes in current directory</span>
0482     <span class="keyword">end</span>
0483     <a name="_sub2" href="#_subfunctions" class="code">function mname = getModelFilePath(model)</a>
0484         fname = <a href="#_sub1" class="code" title="subfunction mname = getModelFileName(model)">getModelFileName</a>(model);
0485         mname = fullfile(filedir,fname); <span class="comment">%absolute path</span>
0486     <span class="keyword">end</span>
0487 
0488 <span class="keyword">end</span>
0489</pre></div>
<hr><address>Generated on Tue 12-Dec-2017 12:31:16 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>